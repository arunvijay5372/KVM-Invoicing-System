{% extends "base.html" %}
{% block title %}Invoice - KVM Enterprises{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="bi bi-receipt"></i> Invoice Details</h3>
  <div>
    <a href="/api/invoices/{{ invoice_id }}/pdf" class="btn btn-success"><i class="bi bi-file-pdf"></i> Download PDF</a>
    <a href="/invoices" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
  </div>
</div>

<div class="card p-4" id="invoiceCard">
  <p class="text-center text-muted">Loading invoice…</p>
</div>

<!-- Status update -->
<div class="card p-3 mt-3">
  <div class="row align-items-end">
    <div class="col-md-4">
      <label class="form-label">Update Status</label>
      <select class="form-select" id="statusSelect">
        <option value="draft">Draft</option>
        <option value="sent">Sent</option>
        <option value="paid">Paid</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
    <div class="col-md-2"><button class="btn btn-primary" onclick="updateStatus()">Update</button></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const invId='{{ invoice_id }}';
function load(){
  fetch('/api/invoices/'+invId).then(r=>r.json()).then(inv=>{
    const c=inv.customer||{};
    const date=inv.invoice_date?new Date(inv.invoice_date).toLocaleDateString('en-IN'):'';
    let html=`
      <div class="text-center mb-3">
        <h4>KVM ENTERPRISES</h4>
        <small class="text-muted">#6, Karumai Amman Kovil Street, Vadapalani, Chennai 600026 | Ph: 9884243950 | GSTIN: 33EFMPS7293G1ZT</small>
        <h5 class="mt-2"><span class="badge bg-dark">TAX INVOICE</span></h5>
      </div>
      <div class="row mb-3">
        <div class="col-md-6"><strong>Invoice #:</strong> ${inv.invoice_number}<br><strong>Date:</strong> ${date}</div>
        <div class="col-md-6 text-md-end"><strong>Status:</strong> <span class="badge bg-${inv.status==='paid'?'success':inv.status==='sent'?'info':'secondary'}">${inv.status.toUpperCase()}</span></div>
      </div>
      <div class="row mb-4">
        <div class="col-md-6">
          <strong>Bill To:</strong><br>${c.name||''}<br>
          ${c.address?c.address+'<br>':''}${[c.city,c.state,c.pincode].filter(Boolean).join(', ')}
          ${c.gstin?'<br>GSTIN: '+c.gstin:''}${c.phone?'<br>Ph: '+c.phone:''}
        </div>
      </div>
      <table class="table table-sm table-bordered">
        <thead class="table-dark"><tr><th>#</th><th>Product</th><th>HSN</th><th>Qty</th><th>Rate</th><th>Disc%</th><th>Taxable</th><th>CGST</th><th>SGST</th><th>Total</th></tr></thead>
        <tbody>`;
    inv.items.forEach((it,i)=>{
      html+=`<tr><td>${i+1}</td><td>${it.product_name}</td><td>${it.hsn_code}</td><td>${it.quantity}</td>
        <td>₹${it.unit_price.toLocaleString('en-IN')}</td><td>${it.discount_percent}</td>
        <td>₹${it.taxable_amount.toLocaleString('en-IN')}</td><td>₹${it.cgst_amount.toLocaleString('en-IN')}</td>
        <td>₹${it.sgst_amount.toLocaleString('en-IN')}</td><td><strong>₹${it.total.toLocaleString('en-IN')}</strong></td></tr>`;
    });
    html+=`</tbody></table>
      <div class="row"><div class="col-md-6"></div><div class="col-md-6">
        <table class="table table-sm"><tbody>
          <tr><td class="text-end">Subtotal:</td><td class="text-end">₹${inv.subtotal.toLocaleString('en-IN')}</td></tr>
          <tr><td class="text-end">CGST (9%):</td><td class="text-end">₹${inv.cgst_total.toLocaleString('en-IN')}</td></tr>
          <tr><td class="text-end">SGST (9%):</td><td class="text-end">₹${inv.sgst_total.toLocaleString('en-IN')}</td></tr>
          <tr class="table-dark"><td class="text-end"><strong>Grand Total:</strong></td><td class="text-end"><strong>₹${inv.grand_total.toLocaleString('en-IN')}</strong></td></tr>
        </tbody></table>
      </div></div>`;
    if(inv.notes) html+=`<p><strong>Notes:</strong> ${inv.notes}</p>`;
    document.getElementById('invoiceCard').innerHTML=html;
    document.getElementById('statusSelect').value=inv.status;
  });
}

function updateStatus(){
  fetch('/api/invoices/'+invId,{method:'PUT',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({status:document.getElementById('statusSelect').value})})
    .then(r=>{if(r.ok){alert('Status updated');load();}else{alert('Error updating status');}});
}
load();
</script>
{% endblock %}
