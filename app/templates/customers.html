{% extends "base.html" %}
{% block title %}Customers - KVM Enterprises{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3><i class="bi bi-people"></i> Customers</h3>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#custModal" onclick="resetForm()"><i class="bi bi-plus-circle"></i> Add Customer</button>
</div>

<div class="card p-3">
  <div class="mb-3"><input type="text" class="form-control" id="searchBox" placeholder="Search customers…"></div>
  <div class="table-responsive">
    <table class="table table-sm table-hover">
      <thead><tr><th>Name</th><th>GSTIN</th><th>Phone</th><th>City</th><th>State</th><th>Action</th></tr></thead>
      <tbody id="custBody"><tr><td colspan="6" class="text-center text-muted">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<!-- Customer modal -->
<div class="modal fade" id="custModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title" id="custModalTitle">Add Customer</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body">
    <input type="hidden" id="custId">
    <div class="mb-2"><label class="form-label">Name *</label><input type="text" class="form-control" id="custName"></div>
    <div class="mb-2"><label class="form-label">GSTIN</label><input type="text" class="form-control" id="custGstin"></div>
    <div class="row">
      <div class="col mb-2"><label class="form-label">Phone</label><input type="text" class="form-control" id="custPhone"></div>
      <div class="col mb-2"><label class="form-label">Email</label><input type="email" class="form-control" id="custEmail"></div>
    </div>
    <div class="mb-2"><label class="form-label">Address</label><input type="text" class="form-control" id="custAddress"></div>
    <div class="row">
      <div class="col mb-2"><label class="form-label">City</label><input type="text" class="form-control" id="custCity"></div>
      <div class="col mb-2"><label class="form-label">State</label><input type="text" class="form-control" id="custState"></div>
      <div class="col mb-2"><label class="form-label">Pincode</label><input type="text" class="form-control" id="custPincode"></div>
    </div>
  </div>
  <div class="modal-footer"><button class="btn btn-primary" onclick="saveCustomer()">Save</button></div>
</div></div></div>
{% endblock %}

{% block extra_js %}
<script>
let allCustomers=[];
function load(){
  fetch('/api/customers').then(r=>r.json()).then(data=>{allCustomers=data;render(data);});
}
function render(items){
  const tb=document.getElementById('custBody');
  if(!items.length){tb.innerHTML='<tr><td colspan="6" class="text-center text-muted">No customers</td></tr>';return;}
  tb.innerHTML=items.map(c=>`<tr>
    <td>${c.name}</td><td>${c.gstin||'-'}</td><td>${c.phone||'-'}</td><td>${c.city||'-'}</td><td>${c.state||'-'}</td>
    <td>
      <button class="btn btn-sm btn-outline-primary" onclick='editCust(${JSON.stringify(c)})'><i class="bi bi-pencil"></i></button>
      <button class="btn btn-sm btn-outline-danger" onclick="deleteCust('${c.id}')"><i class="bi bi-trash"></i></button>
    </td>
  </tr>`).join('');
}
function resetForm(){
  ['custId','custName','custGstin','custPhone','custEmail','custAddress','custCity','custState','custPincode'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('custModalTitle').textContent='Add Customer';
}
function editCust(c){
  document.getElementById('custId').value=c.id;
  document.getElementById('custName').value=c.name;
  document.getElementById('custGstin').value=c.gstin||'';
  document.getElementById('custPhone').value=c.phone||'';
  document.getElementById('custEmail').value=c.email||'';
  document.getElementById('custAddress').value=c.address||'';
  document.getElementById('custCity').value=c.city||'';
  document.getElementById('custState').value=c.state||'';
  document.getElementById('custPincode').value=c.pincode||'';
  document.getElementById('custModalTitle').textContent='Edit Customer';
  new bootstrap.Modal(document.getElementById('custModal')).show();
}
function saveCustomer(){
  const id=document.getElementById('custId').value;
  const data={name:document.getElementById('custName').value.trim(),gstin:document.getElementById('custGstin').value.trim(),
    phone:document.getElementById('custPhone').value.trim(),email:document.getElementById('custEmail').value.trim(),
    address:document.getElementById('custAddress').value.trim(),city:document.getElementById('custCity').value.trim(),
    state:document.getElementById('custState').value.trim(),pincode:document.getElementById('custPincode').value.trim()};
  if(!data.name){alert('Name is required');return;}
  const url=id?'/api/customers/'+id:'/api/customers';
  const method=id?'PUT':'POST';
  fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
    .then(r=>{if(!r.ok) return r.json().then(e=>{throw new Error(e.error)});return r.json();})
    .then(()=>{bootstrap.Modal.getInstance(document.getElementById('custModal')).hide();load();})
    .catch(e=>alert('Error: '+e.message));
}
function deleteCust(id){
  if(!confirm('Delete this customer?')) return;
  fetch('/api/customers/'+id,{method:'DELETE'}).then(r=>{if(r.ok)load();else alert('Error');});
}
document.getElementById('searchBox').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase();
  render(allCustomers.filter(c=>c.name.toLowerCase().includes(q)));
});
load();
</script>
{% endblock %}
