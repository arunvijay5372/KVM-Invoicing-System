{% extends "base.html" %}
{% block title %}Dashboard - KVM Enterprises{% endblock %}

{% block content %}
<style>
  .stat-card{border-radius:12px;border:none;box-shadow:0 2px 10px rgba(0,0,0,.08);transition:transform .2s}
  .stat-card:hover{transform:translateY(-3px)}
  .stat-icon{width:52px;height:52px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
  .brand-card{border-radius:12px;border:none;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden}
  .brand-header{padding:10px 16px;color:#fff;font-weight:600;display:flex;justify-content:space-between;align-items:center}
  .brand-body{padding:14px 16px}
  .progress{height:8px;border-radius:4px}
  .stock-bar{border-radius:4px}
</style>

<h3 class="mb-4"><i class="bi bi-speedometer2"></i> Dashboard</h3>

<!-- ── Top stat cards ── -->
<div class="row g-3 mb-4" id="statCards">
  <div class="col-6 col-lg-3">
    <div class="card stat-card p-3 d-flex flex-row align-items-center gap-3">
      <div class="stat-icon bg-primary bg-opacity-10 text-primary"><i class="bi bi-box-seam-fill"></i></div>
      <div><div class="fs-4 fw-bold" id="totalProducts">-</div><small class="text-muted">Total Products</small></div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card stat-card p-3 d-flex flex-row align-items-center gap-3">
      <div class="stat-icon bg-success bg-opacity-10 text-success"><i class="bi bi-check-circle-fill"></i></div>
      <div><div class="fs-4 fw-bold" id="inStockCount">-</div><small class="text-muted">In Stock</small></div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card stat-card p-3 d-flex flex-row align-items-center gap-3">
      <div class="stat-icon bg-warning bg-opacity-10 text-warning"><i class="bi bi-exclamation-triangle-fill"></i></div>
      <div><div class="fs-4 fw-bold" id="lowStock">-</div><small class="text-muted">Low Stock</small></div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card stat-card p-3 d-flex flex-row align-items-center gap-3">
      <div class="stat-icon bg-info bg-opacity-10 text-info"><i class="bi bi-stack"></i></div>
      <div><div class="fs-4 fw-bold" id="totalUnits">-</div><small class="text-muted">Total Units</small></div>
    </div>
  </div>
</div>

<!-- ── Revenue & Invoices row ── -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card stat-card p-3 text-center" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff">
      <div class="fs-5 opacity-75">Total Revenue</div>
      <div class="fs-3 fw-bold" id="totalRevenue">₹ 0</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card p-3 text-center" style="background:linear-gradient(135deg,#43e97b,#38f9d7);color:#fff">
      <div class="fs-5 opacity-75">Inventory Value</div>
      <div class="fs-3 fw-bold" id="inventoryValue">₹ 0</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card stat-card p-3 text-center" style="background:linear-gradient(135deg,#fa709a,#fee140);color:#fff">
      <div class="fs-5 opacity-75">Total Invoices</div>
      <div class="fs-3 fw-bold" id="totalInvoices">0</div>
      <small class="opacity-75">Today: <span id="todayInvoices">0</span></small>
    </div>
  </div>
</div>

<!-- ── Brand-wise Stock Breakdown ── -->
<h5 class="mb-3"><i class="bi bi-bar-chart-fill text-primary"></i> Brand-wise Stock Overview</h5>
<div class="row g-3 mb-4" id="brandCards">
  <div class="col-12 text-center text-muted">Loading brand data…</div>
</div>

<!-- ── Quick Actions + Recent Invoices ── -->
<div class="row g-3 mb-4">
  <div class="col-lg-4">
    <div class="card p-3 h-100" style="border-radius:12px">
      <h5 class="mb-3"><i class="bi bi-lightning-fill text-warning"></i> Quick Actions</h5>
      <div class="d-grid gap-2">
        <a href="/invoices/new" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Create Invoice</a>
        <a href="/inventory" class="btn btn-outline-secondary"><i class="bi bi-box"></i> Update Inventory</a>
        <a href="/customers" class="btn btn-outline-secondary"><i class="bi bi-people"></i> Manage Customers</a>
        <a href="/brands" class="btn btn-outline-secondary"><i class="bi bi-tags"></i> Manage Brands</a>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card p-3" style="border-radius:12px">
      <h5><i class="bi bi-clock-history text-info"></i> Recent Invoices</h5>
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead><tr><th>Invoice #</th><th>Customer</th><th>Date</th><th>Total</th><th>Status</th></tr></thead>
          <tbody id="recentInvoices"><tr><td colspan="5" class="text-center text-muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const BRAND_COLORS=['#4e73df','#1cc88a','#36b9cc','#f6c23e','#e74a3b','#858796','#5a5c69','#2e59d9'];
fetch('/api/dashboard')
  .then(r=>r.json())
  .then(d=>{
    /* top stats */
    document.getElementById('totalProducts').textContent=d.total_products;
    document.getElementById('inStockCount').textContent=d.in_stock_count;
    document.getElementById('lowStock').textContent=d.low_stock_count;
    document.getElementById('totalUnits').textContent=d.total_units.toLocaleString('en-IN');

    /* revenue row */
    document.getElementById('totalRevenue').textContent='₹ '+d.total_revenue.toLocaleString('en-IN');
    document.getElementById('inventoryValue').textContent='₹ '+d.total_inventory_value.toLocaleString('en-IN');
    document.getElementById('totalInvoices').textContent=d.total_invoices;
    document.getElementById('todayInvoices').textContent=d.today_invoices;

    /* brand cards */
    const bc=document.getElementById('brandCards');
    if(!d.brand_summary||!d.brand_summary.length){
      bc.innerHTML='<div class="col-12 text-center text-muted">No brands found</div>';
    } else {
      const maxQty=Math.max(...d.brand_summary.map(b=>b.total_qty),1);
      bc.innerHTML=d.brand_summary.map((b,i)=>{
        const color=BRAND_COLORS[i%BRAND_COLORS.length];
        const pct=Math.round((b.total_qty/maxQty)*100);
        const okCount=b.products-b.low_stock;
        return `<div class="col-md-6 col-lg-3">
          <div class="card brand-card h-100">
            <div class="brand-header" style="background:${color}">
              <span><i class="bi bi-tags-fill me-1"></i>${b.name}</span>
              <span class="badge bg-light text-dark">${b.products} items</span>
            </div>
            <div class="brand-body">
              <div class="d-flex justify-content-between mb-1"><small class="text-muted">Stock Qty</small><strong>${b.total_qty.toLocaleString('en-IN')}</strong></div>
              <div class="progress mb-3"><div class="progress-bar stock-bar" style="width:${pct}%;background:${color}" role="progressbar"></div></div>
              <div class="d-flex justify-content-between">
                <span class="badge bg-success bg-opacity-10 text-success"><i class="bi bi-check-circle"></i> ${okCount} OK</span>
                <span class="badge bg-danger bg-opacity-10 text-danger"><i class="bi bi-exclamation-circle"></i> ${b.low_stock} Low</span>
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    /* recent invoices */
    const tb=document.getElementById('recentInvoices');
    if(!d.recent_invoices.length){tb.innerHTML='<tr><td colspan="5" class="text-center text-muted">No invoices yet</td></tr>';return;}
    tb.innerHTML=d.recent_invoices.map(inv=>`<tr>
      <td><a href="/invoices/${inv.id}">${inv.invoice_number}</a></td>
      <td>${inv.customer?inv.customer.name:''}</td>
      <td>${inv.invoice_date?new Date(inv.invoice_date).toLocaleDateString('en-IN'):''}</td>
      <td>₹ ${inv.grand_total.toLocaleString('en-IN')}</td>
      <td><span class="badge bg-${inv.status==='paid'?'success':inv.status==='sent'?'info':'secondary'}">${inv.status}</span></td>
    </tr>`).join('');
  });
</script>
{% endblock %}
